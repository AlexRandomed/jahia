This document describes how to install Jahia on Jboss with Jackrabbit

JBoss : 4.2.3.GA
Jackrabbit version : 679434
Jahia : ANDROMEDA
JDK : 1.5.0_11

1/ Install Jboss

Download and unzip Jboss
Edit the bin/run.conf or bin/run.bat (on Windows) to set the max permgen space to 128M with the following parameter in the JAVA_OPTS :
-XX:PermSize=256m -Dorg.jboss.logging.Log4jService.catchSystemOut=false -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp -verbose:gc -Dhibernate.jdbc.use_streams_for_binary=true -Djava.awt.headless=true 

If you run into JMX problems, you could also add

(for Windows in run.bat)

set JAVA_OPTS=%JAVA_OPTS% -Djboss.platform.mbeanserver

(for Unix in run.conf)

# Tell JBossAS to use the platform MBean server
JAVA_OPTS="$JAVA_OPTS -Djboss.platform.mbeanserver"
 

2/ Deploy Jahia
Activate the profiles jboss-deployment and one andromeda-deployment-jboss* profile in your settings.xml, 
and don't forget to adapt the server directory, version, jahia context-path and servlet name in the settings' profile, if you 
want to use a non-default setting.

Call "mvn clean install" in the jahia root directory

3/ Create datasource
a)
Create a jahia-ds.xml file in server/default/deploy folder. The content of this file is dedicated to 
your database configuration. You will find a lot of examples in the following directory of your JBoss  
installation root folder: 
 
jboss/docs/examples/jca 
 
Take one sample file (ie postgres-ds.xml for postgres database), and modify the content of the 
file with your database connection data. 

In this file replace local-tx-datasource with no-tx-datasource.
 
Replace the jndi-name with the following tag: 
 
<jndi-name>jahiaDS</jndi-name> 

Enter a valid connection url to a Jahia database you already created. Update the system user-name/password (e.g. jahia/jahia).

b)
Go to the jahia.war/WEB-INF/lib and move the database driver JAR for your database to server/default/lib.

4/ Modify some files
Exchange the header in all portlet.xml files underneath WEB-INF or subdirectories with
<portlet-app xmlns="http://java.sun.com/xml/ns/portlet/portlet-app_1_0.xsd"
version="1.0"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://java.sun.com/xml/ns/portlet/portlet-app_1_0.xsd
http://java.sun.com/xml/ns/portlet/portlet-app_1_0.xsd">

Please move the server\default\lib\jaxb-impl*.jar to jboss\lib and remove the existing jaxb-impl.jar from there.

Ensure that jboss\lib\endorsed\ has the xalan.jar and xercesImpl.jar inside

5/ Configure Jahia
Modify the "configure" profile with the settings according to your database and other custom settings and
the call "mvn jahia:configure" in the jahia root directory

6/ Security

Add the following lines to server\default\conf\login-config.xml

    <application-policy name="Jackrabbit">
       <authentication>
          <login-module code = "org.jahia.jaas.JahiaLoginModule"
             flag = "required" />
       </authentication>
    </application-policy>
    
7/ 
Do not use DummyTransactionManagers - simply comment them out in the TreeCache xml configuration files in WEB-INF\classes