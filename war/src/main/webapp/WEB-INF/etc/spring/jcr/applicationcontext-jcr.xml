<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">

    <bean id="AbstractJCRStoreProvider" class="org.jahia.services.content.JCRStoreProvider" abstract="true" init-method="start" destroy-method="stop" >
        <property name="userManagerService" ref="JahiaUserManagerService"/>
        <property name="groupManagerService" ref="JahiaGroupManagerService"/>
        <property name="sitesService" ref="JahiaSitesService"/>
        <property name="service" ref="JCRStoreService"/>
    </bean>

    <bean id="jackrabbit" class="org.jahia.services.content.impl.jackrabbit.SpringJackrabbitRepository" init-method="start" destroy-method="stop" >
        <property name="configFile" value="WEB-INF/etc/repository/jackrabbit/repository.xml"/>
        <property name="homeDir" value="WEB-INF/var/repository"/>
        <property name="userService" ref="JahiaUserManagerService"/>
        <property name="groupService" ref="JahiaGroupManagerService"/>
        <property name="sitesService" ref="JahiaSitesService"/>
        <property name="servletContextAttributeName" value="org.jahia.services.content.impl.jackrabbit.SpringJackrabbitRepository" />
    </bean>

    <bean id="DefaulJCRStoreProvider" class="org.jahia.services.content.impl.jackrabbit.JackrabbitStoreProvider" parent="AbstractJCRStoreProvider">
        <property name="key" value="default"/>
        <property name="repository" ref="jackrabbit"/>
        <property name="mountPoint" value="/"/>
        <property name="webdavPath" value="${jahia.deploy.war.contextPath}/repository/default"/>
        <property name="rmibind" value="jackrabbit"/>
        <property name="sessionFactory" ref="jcrSessionFactory"/>
        <property name="listeners">
            <map>
                <entry key="default">
                    <list>
                        <bean class="org.jahia.services.content.FieldReferenceListener">
                            <property name="fieldXRefManager" ref="org.jahia.hibernate.manager.JahiaFieldXRefManager"/>
                        </bean>
                        <bean class="org.jahia.services.content.automation.RulesListener" init-method="start">
                            <property name="ruleFiles" value="/repository/rules/repository-rules.drl" />
                            <property name="serverId" value="${cluster.node.serverId}"/>
                        </bean>
                        <bean class="org.jahia.services.content.textextraction.TextExtractionListener"/>
                        <bean class="org.jahia.services.content.DefaultValueListener"/>
                        <bean class="org.jahia.services.content.CacheListener"/>
                    </list>
                </entry>
                <entry key="live">
                    <list>
                        <bean class="org.jahia.services.content.automation.RulesListener" init-method="start">
                            <property name="ruleFiles" value="/repository/rules/repository-live-rules.drl" />
                            <property name="serverId" value="${cluster.node.serverId}"/>
                        </bean>
                        <bean class="org.jahia.services.content.CacheListener"/>
                    </list>
                </entry>                
            </map>
        </property>
    </bean>

    <bean id="JahiaStoreProvider" class="org.jahia.services.content.impl.jahia.JahiaContentStoreProvider"  parent="AbstractJCRStoreProvider">
        <property name="key" value="jahia"/>
        <property name="rmibind" value="jahia"/>
        <property name="processingContextFactory" ref="org.jahia.params.ProcessingContextFactory"/>
        <property name="sessionFactory" ref="jcrSessionFactory"/>
        <property name="listeners">
            <map>
                <entry key="default">
                    <list>
                        <bean class="org.jahia.services.content.automation.RulesListener" init-method="start">
                            <property name="ruleFiles" value="/repository/rules/jahia-rules.drl" />
                            <property name="serverId" value="${cluster.node.serverId}" />
                        </bean>
                    </list>
                </entry>
                <entry key="live">
                    <list>
                        <bean class="org.jahia.services.content.automation.RulesListener" init-method="start">
                            <property name="ruleFiles" value="/repository/rules/jahialive-rules.drl" />
                            <property name="serverId" value="${cluster.node.serverId}" />
                        </bean>
                    </list>
                </entry>
            </map>
        </property>
        <property name="mountPoint" value="/content/jahia"/>
    </bean>

    <bean id="jcrSessionFactory" class="org.jahia.services.content.JCRSessionFactory" factory-method="getInstance" lazy-init="true">
        <property name="userService" ref="JahiaUserManagerService"/>
        <property name="descriptors">
            <map>
                <entry key="jcr.specification.version" value="1.0"/>
                <entry key="jcr.specification.name"
                       value="Content Repository API for Java(TM) Technology Specification"/>
                <entry key="jcr.repository.vendor" value="Jahia"/>
                <entry key="jcr.repository.vendor.url" value="http://www.jahia.org/"/>
                <entry key="jcr.repository.name" value="Crazy Jane"/>
                <entry key="jcr.repository.version" value="6.5"/>
                <entry key="level.1.supported" value="true"/>
                <entry key="level.2.supported" value="true"/>
                <entry key="option.transactions.supported" value="true"/>
                <entry key="option.versioning.supported" value="true"/>
                <entry key="option.observation.supported" value="false"/>
                <entry key="option.locking.supported" value="true"/>
                <entry key="option.query.sql.supported" value="true"/>
                <entry key="query.xpath.pos.index" value="true"/>
                <entry key="query.xpath.doc.order" value="false"/>
            </map>
        </property>
    </bean>

    <bean id="jcrTemplate" class="org.jahia.services.content.JCRTemplate" factory-method="getInstance">
        <property name="sessionFactory" ref="jcrSessionFactory"/>
    </bean>

    <bean id="JCRStoreService" class="org.jahia.services.content.JCRStoreService" parent="jahiaServiceTemplate"
          factory-method="getInstance" lazy-init="true">
        <property name="fieldXRefManager" ref="org.jahia.hibernate.manager.JahiaFieldXRefManager"/>
        <property name="sessionFactory" ref="jcrSessionFactory"/>
        <property name="decorators">
            <map>
                <entry key="nt:file" value="org.jahia.services.content.JCRFileNode"/>
                <entry key="nt:folder" value="org.jahia.services.content.JCRFileNode"/>
                <entry key="jnt:portlet" value="org.jahia.services.content.JCRPortletNode"/>
                <entry key="nt:query" value="org.jahia.services.content.JCRQueryNode"/>
                <entry key="jnt:mountPoint" value="org.jahia.services.content.JCRMountPointNode"/>
                <entry key="jnt:jahiacontent" value="org.jahia.services.content.JCRJahiaContentNode"/>
                <entry key="jnt:layout" value="org.jahia.services.content.JCRLayoutNode"/>
                <entry key="nt:version" value="org.jahia.services.content.JCRVersion"/>
                <entry key="nt:versionHistory" value="org.jahia.services.content.JCRVersionHistory"/>
                <entry key="nt:frozenNode" value="org.jahia.services.content.JCRFrozenNode"/>
                <entry key="jnt:nodeReference" value="org.jahia.services.content.JCRReferenceNode"/>
                <entry key="jnt:simplePreference"
                       value="org.jahia.services.preferences.generic.GenericJahiaPreference"/>
                <entry key="jnt:pagePreference" value="org.jahia.services.preferences.page.PageJahiaPreference"/>
                <entry key="jnt:toolbarPreference"
                       value="org.jahia.services.preferences.toolbar.ToolbarJahiaPreference"/>
                <entry key="jnt:bookmarkPreference"
                       value="org.jahia.services.preferences.bookmarks.BookmarksJahiaPreference"/>
                <entry key="jnt:portletPreference"
                       value="org.jahia.services.applications.pluto.JahiaPortletPreference"/>
            </map>
        </property>
        <property name="servletContextAttributeName" value="jcrStoreService"/>
    </bean>

</beans>
