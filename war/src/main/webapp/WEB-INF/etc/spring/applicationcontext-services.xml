<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">

    <bean id="proxyTemplate" abstract="true"
          class="org.springframework.aop.framework.ProxyFactoryBean">
        <property name="interceptorNames">
            <list>
                <value>performanceInterceptor</value>
            </list>
        </property>
        <property name="proxyTargetClass" value="true" />
    </bean>

   <bean id="jahiaServiceTemplate" class="org.jahia.services.JahiaService" abstract="true" init-method="start" destroy-method="stop">
      <property name="settingsBean" ref="settingsBean"/>
   </bean>

    <bean id="JahiaPageService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.pages.JahiaPageBaseService" parent="jahiaServiceTemplate" factory-method="getInstance">
            </bean>
        </property>
    </bean>
    <bean id="JahiaPreferencesService" class="org.jahia.services.preferences.JahiaPreferencesService" parent="jahiaServiceTemplate" factory-method="getInstance">
        <property name="cacheService" ref="JahiaCacheService" />
        <property name="jcrStoreService" ref="JCRStoreService" />
        <property name="providerTypes">
            <map>
                <entry key="simple" value="jnt:simplePreference" />
                <entry key="page" value="jnt:pagePreference"  />
                <entry key="portlet" value="jnt:portletPreference"  />
                <entry key="layoutmanager" value="jnt:layout"  />
                <entry key="bookmarks" value="jnt:bookmarkPreference"  />
            </map>
        </property>        
    </bean>
    <bean id="JahiaPageTemplateService" parent="proxyTemplate" >
        <property name="target">
            <bean class="org.jahia.services.pages.JahiaPageTemplateBaseService" parent="jahiaServiceTemplate" factory-method="getInstance">
            </bean>
        </property>
    </bean>
    <bean id="PortletDispatchingProvider" class="org.jahia.services.applications.pluto.PlutoDispatchingProvider" init-method="start" destroy-method="stop"/>
    <bean id="DispatchingService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.applications.DispatchingServiceImpl" parent="jahiaServiceTemplate" factory-method="getInstance">
                <property name="dispatchingProviders">
                    <map>
                        <entry key="portlet" value-ref="PortletDispatchingProvider" />
                    </map>
                </property>
                <property name="applicationsManager" ref="ApplicationsManagerService"/>
            </bean>
        </property>
    </bean>
    <bean id="ServletContextManager" class="org.jahia.services.applications.ServletContextManager" factory-method="getInstance" init-method="start">
        <property name="cacheService" ref="JahiaCacheService"/>
        <property name="settingsBean" ref="settingsBean"/>
    </bean>
    <bean id="QueryService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.query.QueryServiceImpl" parent="jahiaServiceTemplate" factory-method="getInstance">
                <property name="sessionFactory" ref="jcrSessionFactory" />
            </bean>
        </property>
    </bean>    
    <bean id="ApplicationsManagerPortletProvider" class="org.jahia.services.applications.pluto.ApplicationsManagerPlutoProvider" init-method="start" destroy-method="stop"/>
    <bean id="ApplicationsManagerService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.applications.ApplicationsManagerServiceImpl" parent="jahiaServiceTemplate" factory-method="getInstance">
                <property name="managerProviders">
                    <map>
                        <entry key="portlet" value-ref="ApplicationsManagerPortletProvider"/>
                    </map>
                </property>
                <property name="jcrTemplate" ref="jcrTemplate"/>
                <property name="cacheService" ref="JahiaCacheService" />
                <property name="groupManagerService" ref="JahiaGroupManagerService" />
                <property name="servletContextManager" ref="ServletContextManager" />
                <property name="plutoServices" ref="PlutoServices" /> 
            </bean>
        </property>
    </bean>
    <bean id="JahiaFetcherService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.fetchers.JahiaFetcherBaseService" parent="jahiaServiceTemplate" factory-method="getInstance">
            </bean>
        </property>
    </bean>    
    <bean id="JahiaWebAppsDeployerService" parent="proxyTemplate">
        <property name="target">
            <bean class="${JahiaWebAppsDeployerService}" parent="jahiaServiceTemplate" factory-method="getInstance">
            </bean>
        </property>
    </bean>
    <bean id="JahiaFileWatcherService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.deamons.filewatcher.JahiaFileWatcherBaseService" parent="jahiaServiceTemplate" factory-method="getInstance">
                <property name="schedulerService" ref="SchedulerService" />
            </bean>
        </property>
    </bean>
    <bean id="JahiaSitesService" class="org.jahia.services.sites.JahiaSitesBaseService" parent="jahiaServiceTemplate"
          factory-method="getInstance" lazy-init="true">
        <property name="groupService" ref="JahiaGroupManagerService"/>
        <property name="cacheService" ref="JahiaCacheService"/>
        <property name="siteProvider">
            <bean parent="txProxyTemplate">
                <property name="target">
                    <bean class="org.jahia.services.sites.jcr.JCRSitesProvider">
                        <property name="jcrTemplate" ref="jcrTemplate"/>
                    </bean>
                </property>
            </bean>
        </property>
        <property name="fileWatcherService" ref="JahiaFileWatcherService"/>
        <property name="sessionFactory" ref="jcrSessionFactory"/>
    </bean>

    <bean id="JahiaHtmlEditorsService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.htmleditors.HtmlEditorsBaseService" parent="jahiaServiceTemplate" factory-method="getInstance">
            </bean>
        </property>
    </bean>
    <bean id="CategoryService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.categories.CategoryServiceImpl" parent="jahiaServiceTemplate" factory-method="getInstance">
                <property name="cacheService" ref="JahiaCacheService" />
                <property name="categoryProvider" ref="org.jahia.services.categories.jcr.JCRCategoryProvider" />
            </bean>
        </property>
    </bean>
    <bean id="org.jahia.services.categories.jcr.JCRCategoryProvider" parent="txProxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.categories.jcr.JCRCategoryProvider">
                <property name="sessionFactory" ref="jcrSessionFactory"/>
            </bean>
        </property>
    </bean>
    <bean id="org.jahia.services.tags.TaggingService" parent="txProxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.tags.TaggingService"/>
        </property>
    </bean>
    <bean id="HtmlParserService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.htmlparser.HtmlParserBaseService" parent="jahiaServiceTemplate" factory-method="getInstance">
                <property name="parserClassName" value="org.jahia.services.htmlparser.TidyHtmlParser" />
                <!-- 
                <property name="parserClassName" value="org.jahia.services.htmlparser.NekoHtmlParser" />
                 -->
            </bean>
        </property>
    </bean>

    <bean id="ImportExportService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.importexport.ImportExportBaseService" parent="jahiaServiceTemplate" factory-method="getInstance">
                <property name="sitesService" ref="JahiaSitesService" />
                <property name="jcrStoreService" ref="JCRStoreService" />
                <property name="fileWatcherService" ref="JahiaFileWatcherService" />
                <property name="categoryService" ref="CategoryService"/>
            </bean>
        </property>
    </bean>

    <bean id="org.jahia.services.templates.TemplatePackageRegistry" class="org.jahia.services.templates.TemplatePackageRegistry">
        <property name="settingsBean" ref="settingsBean" />
    </bean>

   <bean id="JahiaTemplateManagerService" class="org.jahia.services.templates.JahiaTemplateManagerService" parent="jahiaServiceTemplate" depends-on="jackrabbit">
        <property name="templatePackageDeployer">
            <bean class="org.jahia.services.templates.TemplatePackageDeployer" depends-on="FileListSync">
		    	<property name="settingsBean" ref="settingsBean" />
		      	<property name="templatePackageRegistry" ref="org.jahia.services.templates.TemplatePackageRegistry" />
		      	<property name="importExportService" ref="ImportExportService" />
      			<property name="contextLoader" ref="TemplatePackageApplicationContextLoader" />
            </bean>
        </property>
        <property name="siteService" ref="JahiaSitesService" />
        <property name="tplService" ref="JahiaPageTemplateService" />
        <property name="templatePackageRegistry" ref="org.jahia.services.templates.TemplatePackageRegistry" />
    </bean>
    
    <bean id="TemplatePackageApplicationContextLoader" class="org.jahia.services.templates.TemplatePackageApplicationContextLoader">
    	<property name="contextConfigLocation" value="templates/**/META-INF/spring/*.xml"/>
    </bean>

    <bean id="JahiaFieldDefinitionsRegistry" class="org.jahia.registries.JahiaFieldDefinitionsRegistry" factory-method="getInstance" init-method="init">
        <property name="cacheService" ref="JahiaCacheService" />
    </bean>

    <bean id="VersionService" class="org.jahia.version.VersionService" parent="jahiaServiceTemplate" factory-method="getInstance">
        <property name="jahiaVersionManager" ref="org.jahia.hibernate.manager.JahiaVersionManager"/>
        <property name="patchManager" ref="org.jahia.hibernate.manager.JahiaInstalledPatchManager"/>
    </bean>

    <bean class="org.jahia.services.render.RenderService$RenderServiceBeanPostProcessor"/>

    <bean id="RenderService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.render.RenderService" parent="jahiaServiceTemplate" factory-method="getInstance">
                <property name="storeService" ref="JCRStoreService" />
                <property name="templateManagerService" ref="JahiaTemplateManagerService" />
                <property name="scriptResolvers">
                    <list>
                        <bean class="org.jahia.services.render.scripting.FileSystemScriptResolver">
                            <property name="scriptExtensionsOrdering">
                                <list>
                                    <value>jsp</value>
                                    <value>groovy</value>
                                    <value>js</value>
                                    <value>php</value>
                                    <value>vm</value>
                                    <value>fm</value>
                                </list>
                            </property>
                        </bean>                        
                    </list>
                </property>
                <property name="filters" >
                    <list>
                        <bean class="org.jahia.services.render.filter.portlet.PlutoProcessActionFilter">
                            <property name="priority" value="0" />
                            <property name="applyOnConfigurations" value="page"/>
                            <!--<property name="applyOnMainResource" value="true"/>-->
                        </bean>
                        <bean class="org.jahia.services.render.filter.ContributionFilter" >
                            <property name="priority" value="3" />
                            <property name="applyOnModes" value="contribution" />
                            <property name="applyOnNodeTypes" value="jmix:contributeMode"/>
                            <property name="skipOnConfiguration" value="include,wrapper,option"/>
                        </bean>
                        <bean class="org.jahia.services.render.filter.BaseAttributesFilter" >
                            <property name="priority" value="5" />
                        </bean>
                        <bean class="org.jahia.services.render.filter.TemplatePermissionCheckFilter" >
                            <property name="priority" value="10" />
                            <property name="skipOnConfiguration" value="include,wrapper,option"/>
                        </bean>
                        <bean class="org.jahia.services.render.filter.MetricsLoggingFilter" >
                            <property name="priority" value="15" />
                            <property name="loggingService" ref="loggingService"/>
                            <property name="skipOnConfiguration" value="include,wrapper,option"/>
                        </bean>
                        <ref bean="cacheFilter"/>
                        <bean class="org.jahia.services.render.filter.TemplateAttributesFilter" >
                            <property name="priority" value="30" />
                        </bean>
                        <bean class="org.jahia.services.render.filter.URLFilter" >
                        	<constructor-arg ref="org.jahia.services.render.filter.URLTraverser"/>
                            <property name="priority" value="35" />
                            <property name="applyOnConfigurations" value="page,gwt"/>
                            <!--<property name="applyOnMainResource" value="true"/>                            -->
                            <property name="handlers">
                            	<list>
                            		<bean class="org.jahia.services.render.filter.ContextPlaceholdersReplacer"/>
                            		<bean class="org.jahia.services.seo.filter.VanityUrlSetter">                            		
               		                    <property name="vanityUrlService" ref="org.jahia.services.seo.jcr.VanityUrlService"/>
                            		</bean>
                            	</list>
                            </property>
                        </bean>
                        <bean class="org.jahia.services.render.filter.WrapperFilter" >
                            <property name="priority" value="40" />
                            <property name="skipOnConfiguration" value="include,wrapper,option"/>
                        </bean>
                        <bean class="org.jahia.services.render.filter.OptionsFilter" >
                            <property name="priority" value="50" />
                            <property name="skipOnConfiguration" value="include,wrapper,option"/>
                        </bean>
                        <bean class="org.jahia.services.render.filter.analytics.GoogleAnalyticsFilter">
                            <property name="applyOnNodeTypes" value="jmix:googleanalytics"/>
                            <property name="skipOnConfiguration" value="include,wrapper,option"/>
                            <property name="priority" value="98" />
                        </bean>
                        <bean class="org.jahia.services.render.filter.TemplateScriptFilter" >
                            <property name="priority" value="99" />
                        </bean>
                    </list>
                </property>
            </bean>
        </property>

    </bean>
    
    <bean id="org.jahia.services.render.filter.URLTraverser" class="org.jahia.services.render.filter.HtmlTagAttributeTraverser">
    	<constructor-arg>
    		<map>
    			<entry key="a">
    				<set><value>href</value></set>
    			</entry>
    			<entry key="embed">
    				<set><value>src</value></set>
    			</entry>
    			<entry key="img">
    				<set><value>src</value></set>
    			</entry>
    			<entry key="param">
    				<set><value>value</value></set>
    			</entry>
    		</map>
    	</constructor-arg>
    </bean>

    <bean id="org.jahia.services.tasks.TaskService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.tasks.TaskService">
            	<property name="groupManager" ref="JahiaGroupManagerService"/>
            </bean>
        </property>
    </bean>
    
    <bean id="SearchService" parent="proxyTemplate">
        <property name="target">
            <bean class="org.jahia.services.search.SearchServiceImpl" parent="jahiaServiceTemplate" factory-method="getInstance">
            	<property name="searchProvider" ref="org.jahia.services.search.jcr.JahiaJCRSearchProvider"/>
            </bean>
        </property>
    </bean>

    <bean id="org.jahia.services.search.jcr.JahiaJCRSearchProvider" class="org.jahia.services.search.jcr.JahiaJCRSearchProvider"/>

    <bean id="GoogleAnalyticsService" class="org.jahia.services.analytics.GoogleAnalyticsService" factory-method="getInstance" />
    
    <bean id="org.jahia.services.seo.jcr.VanityUrlManager" class="org.jahia.services.seo.jcr.VanityUrlManager"/>    
    <bean id="org.jahia.services.seo.jcr.VanityUrlService" class="org.jahia.services.seo.jcr.VanityUrlService">
        <property name="vanityUrlManager" ref="org.jahia.services.seo.jcr.VanityUrlManager"/>    
    </bean>
    
    <bean id="org.jahia.services.render.StaticAssetMappingRegistry" class="org.springframework.beans.factory.config.MapFactoryBean">
        <property name="sourceMap">
            <map/>
        </property>
    </bean>

</beans>
