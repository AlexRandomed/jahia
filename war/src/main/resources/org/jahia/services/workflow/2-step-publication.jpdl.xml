<?xml version="1.0" encoding="UTF-8"?>

<process key="2-step-publication" name="2 Step Publication Process" xmlns="http://jbpm.org/4.3/jpdl">
    <start form="jnt:simpleTimebasedPublished" g="33,307,80,40" name="start">
        <transition to="lock"/>
    </start>
    <custom class="org.jahia.services.workflow.jbpm.custom.Lock" g="119,311,80,40" name="lock">
        <transition to="first review"/>
    </custom>
    <task form="jnt:simpleTimebasedPublished" g="243,310,80,40" name="first review">
        <assignment-handler class="org.jahia.services.workflow.jbpm.JBPMTaskAssignmentListener"/>
        <transition g="-18,-17" name="accept" to="final review"/>
        <transition g="133,-16" name="reject" to="unlock"/>
        <transition g="-55,-8" name="correction needed" to="unlock for correction"/>
    </task>
    <task form="jnt:simpleTimebasedPublished" g="370,306,80,40" name="final review">
        <assignment-handler class="org.jahia.services.workflow.jbpm.JBPMTaskAssignmentListener"/>
        <transition g="-23,-19" name="publish" to="publication"/>
        <transition g="-30,3" name="reject" to="unlock"/>
        <transition g="-34,-15" name="correction needed" to="unlock for correction"/>
    </task>
    <custom class="org.jahia.services.workflow.jbpm.custom.Unlock" g="458,370,80,40" name="unlock">
        <transition to="end"/>
    </custom>
    <decision name="publication" g="534,293,80,40">
        <transition to="publish">
            <condition expr="#{empty startDate}"/>
        </transition>
        <transition to="timeBasedPublication">
            <condition expr="#{not empty startDate}"/>
        </transition>
    </decision>
    <state name="timeBasedPublication" g="531,422,80,40">
        <transition name="timeout" to="publish" g="-48,-22">
            <timer duedate="#{startDate[0].value}"/>
        </transition>
    </state>
    <custom class="org.jahia.services.workflow.jbpm.custom.Publish" g="655,289,80,40" name="publish">
        <transition name="timeBasedUnpublish" to="timeBasedUnpublication" g="-114,-18"/>
        <transition g="-2,-22" name="to end" to="end"/>
    </custom>
    <state name="timeBasedUnpublication" g="858,101,80,40">
        <transition name="timeout" to="unpublish" g="-46,-18">
            <timer duedate="#{endDate[0].value}"/>
        </transition>
    </state>
    <custom class="org.jahia.services.workflow.jbpm.custom.Unpublish" g="676,100,101,40" name="unpublish">
        <transition to="end"/>
    </custom>
    <end g="916,272,80,40" name="end"/>
    <custom class="org.jahia.services.workflow.jbpm.custom.Unlock" g="220,470,133,39" name="unlock for correction">
        <transition to="finish correction"/>
    </custom>
    <task form="jnt:simpleTimebasedPublished" g="104,205,116,39" name="finish correction">
        <assignment-handler class="org.jahia.services.workflow.jbpm.JBPMTaskAssignmentListener"/>
        <transition g="-45,-11" name="finished" to="lock"/>
    </task>
</process>