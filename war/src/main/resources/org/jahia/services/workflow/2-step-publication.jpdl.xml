<?xml version="1.0" encoding="UTF-8"?>

<process name="2 Step Publication Process" key="2-step-publication" xmlns="http://jbpm.org/4.3/jpdl">
    <start g="33,307,80,40" name="start" form="jnt:simpleTimebasedPublished">
        <transition to="lock"/>
    </start>
    <custom class="org.jahia.services.workflow.jbpm.custom.Lock" g="119,311,80,40" name="lock">
        <transition to="first review"/>
    </custom>
    <task g="243,310,80,40" name="first review" form="jnt:simpleTimebasedPublished">
        <assignment-handler class="org.jahia.services.workflow.jbpm.JBPMTaskAssignmentListener"/>
        <transition g="-18,-17" name="accept" to="final review"/>
        <transition g="343,372:133,-16" name="reject" to="unlock"/>
        <transition name="correction needed" to="unlock for correction" g="-55,-8"/>
    </task>
    <task g="449,265,80,40" name="final review" form="jnt:simpleTimebasedPublished">
        <assignment-handler class="org.jahia.services.workflow.jbpm.JBPMTaskAssignmentListener"/>
        <transition g="-23,-19" name="publish" to="publication"/>
        <transition g="-30,3" name="reject" to="unlock"/>
        <transition g="452,220:-34,-15" name="correction needed" to="unlock for correction"/>
    </task>
    <custom class="org.jahia.services.workflow.jbpm.custom.Unlock" g="585,310,80,40" name="unlock">
        <transition to="end"/>
    </custom>
    <decision name="publication">
        <transition to="publish">
            <condition expr="#{empty startDate}"/>
        </transition>
        <transition to="timeBasedPublication">
            <condition expr="#{not empty startDate}"/>
        </transition>
    </decision>
    <state name="timeBasedPublication">
        <transition name="timeout" to="publish">
            <timer duedate="#{startDate[0].value}"/>
        </transition>
    </state>
    <custom class="org.jahia.services.workflow.jbpm.custom.Publish" g="380,165,80,40" name="publish">
        <transition name="timeBasedUnpublish" to="timeBasedUnpublication"/>
        <transition name="to end" to="execute remote publication" g="-2,-22"/>
    </custom>
    <state name="timeBasedUnpublication">
        <transition name="timeout" to="unpublish">
            <timer duedate="#{endDate[0].value}"/>
        </transition>
    </state>
    <custom class="org.jahia.services.workflow.jbpm.custom.Unpublish" name="unpublish" g="296,141,101,40">
        <transition to="execute remote publication"/>
    </custom>
    <end g="683,263,80,40" name="end"/>
    <custom class="org.jahia.services.workflow.jbpm.custom.Unlock" name="unlock for correction" g="259,203,133,39">
        <transition to="finish correction"/>
    </custom>
    <task name="finish correction" g="104,205,116,39" form="jnt:simpleTimebasedPublished">
        <assignment-handler class="org.jahia.services.workflow.jbpm.JBPMTaskAssignmentListener"/>
        <transition name="finished" to="lock" g="-45,-11"/>
    </task>
    <custom class="org.jahia.modules.remotepublish.jbpm.custom.CallRemotePublish" g="582,223,80,40" name="execute remote publication">
        <transition name="choose remote publication" to="choose remote publication"/>
        <transition name="no remote publication" to="end"/>
    </custom>
    <task name="choose remote publication" g="104,205,116,39" form="jnt:workflowRemotePublicationForm">
        <assignment-handler class="org.jahia.services.workflow.jbpm.JBPMTaskAssignmentListener"/>
        <transition name="remote publish" to="remote publication" g="-45,-11"/>
        <transition g="-30,3" name="bypass" to="end"/>
    </task>
    <custom class="org.jahia.modules.remotepublish.jbpm.custom.ExecuteRemotePublish" g="582,223,80,40" name="remote publication">
        <transition to="end"/>
    </custom>
</process>