<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE urlrewrite PUBLIC "-//tuckey.org//DTD UrlRewrite 3.2//EN"
        "http://tuckey.org/res/dtds/urlrewrite3.2.dtd">

<urlrewrite>

    <!-- Block direct access -->
    <rule enabled="true">
        <name>Block direct access</name>
        <note>Restricts direct access to the resources</note>
        <condition type="attribute" name="javax.servlet.forward.request_uri" operator="equal">^$</condition>
        <condition type="attribute" name="jahiaResourceAccessGranted" operator="equal">^$</condition>
        <from>^/(LICENSE|modules/.*/META-INF/.*|modules/.*/WEB-INF/.*|modules/.*/mails/.*|modules/.*\.cnd|modules/.*\.drl|modules/.*\.dsl|modules/.*\.properties)$</from>
        <set type="status">404</set>
        <set type="request" name="UrlRewriteFilter.sendError">404</set>
        <to>null</to>        
    </rule>
    <!-- end of block direct access -->
    
    <rule enabled="true">
        <name>OSGi Web console access</name>
        <note>Allow access via /tools/osgi/* path only to the OSGi Web console</note>
        <condition type="attribute" name="javax.servlet.forward.request_uri" operator="equal">^$</condition>
        <condition type="request-uri" operator="notequal">^(/[\p{Alnum}\-_]*)?/tools/osgi/console(/.*)?</condition>
        <from>^/tools/osgi/.*$</from>
        <set type="status">404</set>
        <set type="request" name="UrlRewriteFilter.sendError">404</set>
        <to>null</to>        
    </rule>
    
    <!-- GWT resources-->
    <rule>
        <note>GWT CSS</note>
        <from>^/gwt/(manager|edit)/(.*)\.css$</from>
        <to>/gwt/resources/$1.css</to>
    </rule>
    <rule>
        <note>GWT images</note>
        <from>^/gwt/(manager|edit)/images/(.*)$</from>
        <to>/gwt/resources/images/$2</to>
    </rule>
    <rule>
        <note>GWT CSS images</note>
        <from>^/gwt/resources/css/images/(.*)$</from>
        <to>/gwt/resources/images/$1</to>
    </rule>
    <!-- end of GWT resources-->

    <!-- Jahia tools -->
    <rule enabled="true">
        <name>Jahia tools</name>
        <note>Redirects to Jahia Tools overview page</note>
        <from>^/tools(/)?$</from>
        <to type="redirect">%{context-path}/tools/index.jsp</to>
    </rule>

    <outbound-rule>
        <name>lang placehodler</name>
        <note>Replace {lang} placeholder</note>
        <from>^([^?]*)\{lang\}(.*)$</from>
        <run class="org.jahia.services.seo.urlrewrite.ServerNameToSiteMapper" method="getLinkLocale(HttpServletRequest, String, String)"/>
        <to>$1%{attribute:currentLinkLocale}$2</to>
    </outbound-rule>
    <outbound-rule>
        <name>workspace placeholder</name>
        <note>Replace {workspace} placeholder</note>
        <from>^([^?]*)\{workspace\}(.*)$</from>
        <to>$1%{attribute:currentWorkspace}$2</to>
    </outbound-rule>
    <outbound-rule>
        <name>mode placeholder</name>
        <note>Replace {mode} placeholder</note>
        <from>^([^?]*)\{mode\}(.*)$</from>
        <to>$1%{attribute:currentMode}$2</to>
    </outbound-rule>

    <outbound-rule>
        <name>Vanity url</name>
        <note>Check for vanity urls</note>
        <from>^(.*)$</from>
        <run class="org.jahia.services.seo.jcr.VanityUrlMapper" method="checkVanityUrl(HttpServletRequest, String)"/>
        <to>%{attribute:vanityUrl}</to>
    </outbound-rule>
    <!-- Jahia Administration -->
    <rule enabled="true">
        <name>Jahia Administration</name>
        <note>Redirects to new Jahia Server Administration page</note>
        <from>^/administration(/)?$</from>
        <to type="redirect">%{context-path}/welcome/adminmode</to>
    </rule>
    
</urlrewrite>